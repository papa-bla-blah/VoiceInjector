# VoiceInjector - Project Memory

**Status**: ✅ **COMPLETE & WORKING** (v1.0+)  
**Last Updated**: 2026-01-14  
**Location**: ProtonDrive ClaudeProjectsDev/VoiceInjector/

---

## 1. What It Does

macOS menu bar app for continuous speech-to-text with cursor injection
- Hands-free text input across ALL macOS applications
- On-device privacy (Apple SFSpeechRecognizer)
- Real-time audio visualizer
- Global hotkey toggle (Option+V)

**GitHub**: https://github.com/papa-bla-blah/VoiceInjector

---

## 2. Current Status & Features

### ✅ Complete Features (v1.0):
- [x] Menu bar icon toggle
- [x] Continuous microphone listening
- [x] Real-time speech-to-text transcription (on-device)
- [x] Text injection at cursor via CGEvent
- [x] Multi-utterance support (1.8s silence detection)
- [x] Permission onboarding (Accessibility, Microphone, Speech)
- [x] 8-bar audio visualizer with voice level response
- [x] Global hotkey (Option+V)
- [x] Audio Mode menu (Standard / Voice Isolation)
- [x] 2.5x input gain boost for normal speaking volume

### Platform Requirements:
- macOS 14.0+
- Apple Silicon (M1) or Intel
- Microphone access
- Accessibility permissions

---

## 3. Architecture

### File Structure:
```
VoiceInjector/
├── project.yml                    # XcodeGen config
├── VoiceInjector_agent.md         # This file
├── progress_sum.md
├── VoiceInjector.xcodeproj/       # Generated by xcodegen
└── VoiceInjector/
    ├── Sources/
    │   ├── VoiceInjectorApp.swift       # @main entry, AppDelegate
    │   ├── SpeechManager.swift          # AVAudioEngine + SFSpeechRecognizer
    │   ├── InputBridge.swift            # CGEvent keystroke simulation
    │   ├── StatusBarController.swift    # Menu bar UI + Audio Mode menu
    │   ├── PermissionsChecker.swift     # Permission verification
    │   ├── AudioLevelMonitor.swift      # Audio level processing
    │   └── AudioVisualizerWindow.swift  # Floating equalizer UI
    └── Resources/
        ├── Info.plist                   # LSUIElement=true, usage descriptions
        └── VoiceInjector.entitlements   # Sandbox disabled for CGEvent
```

### Key Technical Decisions:

| Decision | Rationale |
|----------|-----------|
| AVAudioEngine + SFSpeechRecognizer | Native Apple APIs, on-device privacy |
| CGEvent keystroke simulation | Works across all apps including browsers |
| Sandbox disabled | Required for system-wide event posting |
| XcodeGen | Programmatic project generation from YAML |
| 1.8s silence threshold | Balance between responsiveness and accuracy |
| AVAudioUnitEQ gain node (2.5x) | Amplify quiet speech for better recognition |
| Error 1110 handling | Wait for speech, don't restart loop |

---

## 4. Build & Run

### Quick Start:
```bash
# Build:
cd VoiceInjector/
xcodegen generate
xcodebuild -project VoiceInjector.xcodeproj -scheme VoiceInjector -configuration Debug -derivedDataPath ./build build

# Run:
open build/Build/Products/Debug/VoiceInjector.app

# Or with debug output:
build/Build/Products/Debug/VoiceInjector.app/Contents/MacOS/VoiceInjector
```

### Usage:
1. Press **Option+V** (or click menu bar icon) to toggle listening
2. Floating visualizer shows audio levels
3. Speak naturally at normal volume
4. After 1.8s silence → text injects at cursor
5. Continues listening for next utterance
6. **Right-click icon** → Audio Mode → Standard / Voice Isolation

---

## 5. Known Issues & Solutions

### Bugs Fixed:

| Bug | Root Cause | Solution |
|-----|-----------|----------|
| AVAudioSession crash | iOS-only API used on macOS | Removed - not needed on macOS |
| Infinite restart loop | Error 1110 triggered immediate restart | Wait for actual speech, don't restart on 1110 |
| Visualizer too quiet | Low sensitivity (5x) | Boosted to 25x multiplier |
| Low microphone sensitivity | No input gain | Added AVAudioUnitEQ with 2.5x boost |

### Proven Patterns:
- SFSpeechRecognizer error 1110 during silence is **NORMAL** - just wait
- Error 301 "cancelled" expected during task restart - ignore it
- Use silence timer (1.8s) to inject partial results
- Restart recognition only after successful injection
- Feed audio buffer to both recognizer AND visualizer
- XcodeGen regenerates project when adding new Swift files

---

## 6. Future Enhancements (Optional)

- [ ] Adjustable silence threshold in menu
- [ ] Multiple language support
- [ ] Code signing for App Store distribution
- [ ] Customizable global hotkey
- [ ] Voice command triggers (e.g., "new line", "delete")
- [ ] Text formatting commands ("capitalize", "all caps")

---

## 7. Development History

### v1.0 (2026-01-13):
- Initial release with all core features
- 8-bar audio visualizer
- Global hotkey (Option+V)
- Smooth first-time project success (~1 hour dev time)

### v1.1 (2026-01-14):
- Added Audio Mode menu (Standard / Voice Isolation)
- Implemented 2.5x input gain boost via AVAudioUnitEQ
- Improved sensitivity for normal speaking volume

---

## 8. Project Success Notes

**This was the first smooth, successful Claude project build!**

Key success factors:
1. Clear project scope from the start
2. Iterative debugging with real-time logs
3. Quick root cause identification
4. User feedback driving improvements

---

*For environment setup, see ~/agent.md*  
*For detailed release notes, see progress_sum.md*
